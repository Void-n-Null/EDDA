# EDDA Docker Compose Configuration
#
# Services:
#   - tts-service: Chatterbox Turbo TTS (GPU-accelerated)
#   - qdrant: Vector database for conversation memory
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose logs -f tts        # View TTS logs
#   docker-compose down               # Stop all services
#   docker-compose build tts          # Rebuild TTS image
#
# Note: The C# server runs directly on the host, not in Docker.

# Docker Compose v2 (no version field needed)
services:
  # ============================================================================
  # Chatterbox Turbo TTS Service
  # ============================================================================
  tts:
    build:
      context: ../tts-service
      dockerfile: Dockerfile
    container_name: edda-tts
    ports:
      - "5000:5000"
    environment:
      - TTS_DEVICE=cuda
      - TTS_PORT=5000
      - LOG_LEVEL=INFO
    volumes:
      # Mount voice reference files (for voice cloning)
      - ../voices:/app/voices:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Model loading takes time
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ============================================================================
  # Qdrant Vector Database
  # ============================================================================
  qdrant:
    image: qdrant/qdrant:v1.12.1
    container_name: edda-qdrant
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readiness"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

volumes:
  qdrant-data:
    driver: local

networks:
  default:
    name: edda-network

